# ─────────────────────────────────────────────────────────────
# AI Receptionist — Pilot Deployment nginx Configuration
# ─────────────────────────────────────────────────────────────
#
# This config provides:
#   1. TLS termination (Let's Encrypt / any cert)
#   2. HTTP → HTTPS redirect
#   3. Proxy to the Node.js backend on port 3000
#   4. WebSocket upgrade for Socket.IO (/ws)
#   5. X-Forwarded-Proto header so the backend's HTTPS
#      enforcement hook can verify the connection is secure
#
# Prerequisites:
#   - nginx installed (apt install nginx)
#   - TLS cert + key (certbot: sudo certbot --nginx -d api.your-domain.com)
#   - Backend running on localhost:3000 with REQUIRE_HTTPS=true
#
# Usage:
#   1. Copy this file to /etc/nginx/sites-available/ai-receptionist
#   2. Replace YOUR_DOMAIN with your actual domain
#   3. Replace cert paths with your real cert paths
#   4. sudo ln -s /etc/nginx/sites-available/ai-receptionist /etc/nginx/sites-enabled/
#   5. sudo nginx -t && sudo systemctl reload nginx
# ─────────────────────────────────────────────────────────────

# Redirect all HTTP traffic to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name YOUR_DOMAIN;

    # Let's Encrypt ACME challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Everything else → HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS server — TLS termination + reverse proxy
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name YOUR_DOMAIN;

    # ── TLS Certificates ─────────────────────────────────────
    # Replace with your actual cert paths (e.g. from certbot)
    ssl_certificate     /etc/letsencrypt/live/YOUR_DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/YOUR_DOMAIN/privkey.pem;

    # ── TLS Hardening ────────────────────────────────────────
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # ── Security Headers ─────────────────────────────────────
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # ── Proxy to Backend ─────────────────────────────────────
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;

        # WebSocket support (required for Socket.IO on /ws)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Forward client info
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # ⚠️  CRITICAL: This header is what the backend checks
        # when REQUIRE_HTTPS=true. Without it, all requests will
        # be rejected with 403.
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts for long-polling/WebSocket
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # ── Static Frontend (optional) ───────────────────────────
    # If serving the Vite-built frontend from the same domain,
    # uncomment and adjust:
    #
    # location /app {
    #     alias /var/www/ai-receptionist/dist;
    #     try_files $uri $uri/ /app/index.html;
    # }
}
